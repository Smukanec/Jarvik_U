<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jarvik Mobile</title>
  <style>
    body {
      font-family: monospace;
      background-color: #121212;
      color: #c8f6c8;
      margin: 1em;
    }
    textarea, select {
      width: 100%;
      padding: 0.8em;
      font-size: 1em;
      border: 2px solid #00ff00;
      border-radius: 8px;
      background-color: #1e1e1e;
      color: #c8f6c8;
    }
    button {
      background-color: #00aa00;
      color: white;
      border: none;
      padding: 0.6em 1.2em;
      font-size: 1em;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 0.5em;
    }
    button:hover {
      background-color: #007700;
    }
    pre {
      background-color: #1e1e1e;
      border: 1px solid #2e7d32;
      padding: 1em;
      border-radius: 8px;
      margin-top: 1em;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #response {
      min-height: 200px;
    }
    #spinner {
      margin-top: 0.5em;
    }
    details summary {
      cursor: pointer;
      font-weight: bold;
      color: #00ff00;
      margin-top: 1em;
    }
  </style>
</head>
<body>
  <img src="/static/alternativ.png" alt="Jarvik logo" style="max-height:80px;">
  <div id="login" style="display:none">
    <input id="nick" placeholder="nick"><br>
    <input id="password" type="password" placeholder="password"><br>
    <input id="apikey" placeholder="API key (optional)"><br>
    <button onclick="doLogin()">Login</button>
    <pre id="login-status"></pre>
  </div>

  <div id="interface" style="display:none">
    <h2 id="current-model-display">Model: <span id="current-model">?</span></h2>
    <select id="model-select">
      <option value="openchat" title="Chytr√Ω AI asistent. Vhodn√Ω pro bƒõ≈æn√© ot√°zky, dialog a porozumƒõn√≠ pokyn≈Øm.">OpenChat ‚Äì chytr√Ω AI asistent üåê</option>
      <option value="llama3:8b" title="Vysok√° p≈ôesnost, vhodn√Ω pro slo≈æitƒõj≈°√≠ dotazy, rozum√≠ webov√©mu obsahu i dokument≈Øm.">LLaMA 3 8B ‚Äì velk√Ω jazykov√Ω model üåê</option>
      <option value="nous-hermes2" title="Dob≈ôe zvl√°d√° ot√°zky, form√°ln√≠ texty i instrukce, vhodn√Ω i pro slo≈æitƒõj≈°√≠ dotazy s doplnƒõn√≠m z internetu.">Nous Hermes 2 ‚Äì jemnƒõ doladƒõn√Ω Mistral üåê</option>
      <option value="command-r" title="Optimalizovan√Ω pro programov√°n√≠, Python, shell, k√≥dov√© √∫koly.">Command R ‚Äì model pro RAG üåê</option>
      <option value="api" title="Extern√≠ API ‚Äì dotazy jsou pos√≠l√°ny do API.">Extern√≠ API</option>
    </select>
    <p id="model-desc"></p>
    <button onclick="switchModel()">Switch model</button>

    <textarea id="message" rows="4" placeholder="Zadej dotaz‚Ä¶"></textarea><br>
    <input type="file" id="file"><br>
    <label><input type="checkbox" id="save-txt"> Ulo≈æit odpovƒõƒè do txt</label><br>
    <label><input type="radio" name="mem" id="mem-private" value="1" checked> Soukrom√°</label>
    <label><input type="radio" name="mem" value="0"> Ve≈ôejn√°</label><br>
    <button onclick="ask()">Odeslat</button>
    <div id="spinner" style="display:none">‚è≥</div>

    <pre id="response"></pre>
    <a id="download" style="display:none" href="#">‚¨áÔ∏è St√°hnout odpovƒõƒè</a>
    <details>
      <summary>üìñ Kontext</summary>
      <pre id="context"></pre>
    </details>
  </div>

<script>
const MODEL_INFO = {
  'openchat': {
    label: 'OpenChat ‚Äì chytr√Ω AI asistent üåê',
    web: true,
    desc: 'Chytr√Ω AI asistent. Vhodn√Ω pro bƒõ≈æn√© ot√°zky, dialog a porozumƒõn√≠ pokyn≈Øm.'
  },
  'nous-hermes2': {
    label: 'Nous Hermes 2 ‚Äì jemnƒõ doladƒõn√Ω Mistral üåê',
    web: true,
    desc: 'Dob≈ôe zvl√°d√° ot√°zky, form√°ln√≠ texty i instrukce, vhodn√Ω i pro slo≈æitƒõj≈°√≠ dotazy s doplnƒõn√≠m z internetu.'
  },
  'llama3:8b': {
    label: 'LLaMA 3 8B ‚Äì velk√Ω jazykov√Ω model üåê',
    web: true,
    desc: 'Vysok√° p≈ôesnost, vhodn√Ω pro slo≈æitƒõj≈°√≠ dotazy, rozum√≠ webov√©mu obsahu i dokument≈Øm.'
  },
  'command-r': {
    label: 'Command R ‚Äì model pro RAG üåê',
    web: true,
    desc: 'Optimalizovan√Ω pro programov√°n√≠, Python, shell, k√≥dov√© √∫koly.'
  },
  'api': {
    label: 'Extern√≠ API',
    web: false,
    desc: 'Extern√≠ API ‚Äì dotazy jsou pos√≠l√°ny do API.'
  }
};

const MODEL_NAMES = Object.fromEntries(
  Object.entries(MODEL_INFO).map(([k, v]) => [k, v.label])
);
const MODEL_DESCRIPTIONS = Object.fromEntries(
  Object.entries(MODEL_INFO).map(([k, v]) => [k, v.desc])
);
let token = localStorage.getItem('token') || '';
let apiKey = localStorage.getItem('apiKey') || '';

function authFetch(url, options = {}) {
  options.headers = options.headers || {};
  if (token) options.headers['Authorization'] = 'Bearer ' + token;
  if (apiKey) options.headers['X-API-Key'] = apiKey;
  return fetch(url, options);
}

function updateModelDesc() {
  const val = document.getElementById('model-select').value;
  document.getElementById('model-desc').textContent = MODEL_DESCRIPTIONS[val] || '';
}

async function loadModel() {
  const res = await authFetch('/model');
  const data = await res.json();
  const name = MODEL_NAMES[data.model] || data.model;
  document.getElementById('current-model').textContent = name;
  const sel = document.getElementById('model-select');
  if (sel) {
    let option = Array.from(sel.options).find(o => o.value === data.model);
    if (!option) {
      option = new Option(name, data.model);
      sel.appendChild(option);
    }
    sel.value = data.model;
    updateModelDesc();
  }
}

async function switchModel() {
  const model = document.getElementById('model-select').value;
  await authFetch('/model', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ model })
  });
  const name = MODEL_NAMES[model] || model;
  document.getElementById('current-model').textContent = name;
  updateModelDesc();
}

function showInterface() {
  document.getElementById('login').style.display = 'none';
  document.getElementById('interface').style.display = 'block';
  loadModel();
  const sel = document.getElementById('model-select');
  if (sel) {
    sel.addEventListener('change', () => {
      switchModel();
      updateModelDesc();
    });
    updateModelDesc();
  }
}

async function checkAuth() {
  if (!token) {
    document.getElementById('login').style.display = 'block';
    document.getElementById('apikey').value = apiKey;
    return;
  }
  const res = await authFetch('/model');
  if (res.status === 401) {
    document.getElementById('login').style.display = 'block';
    token = '';
    localStorage.removeItem('token');
  } else {
    showInterface();
  }
}

async function doLogin() {
  const nick = document.getElementById('nick').value.trim();
  const password = document.getElementById('password').value;
  apiKey = document.getElementById('apikey').value.trim();
  if (apiKey) localStorage.setItem('apiKey', apiKey);
  const res = await fetch('/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ nick, password })
  });
  if (res.ok) {
    const data = await res.json();
    token = data.token;
    localStorage.setItem('token', token);
    document.getElementById('login-status').textContent = '';
    showInterface();
  } else {
    document.getElementById('login-status').textContent = 'Login failed';
  }
}

async function ask() {
  const msg = document.getElementById('message').value.trim();
  const fileInput = document.getElementById('file');
  const file = fileInput.files[0];
  if (!msg && !file) return;
  document.getElementById('spinner').style.display = 'block';
  document.getElementById('response').textContent = '';
  document.getElementById('download').style.display = 'none';
  try {
    const ctxRes = await authFetch('/knowledge/search?q=' + encodeURIComponent(msg));
    if (ctxRes.ok) {
      const ctxData = await ctxRes.json();
      const ctxText = ctxData.length ? ctxData.join("\n\n---\n\n") : '(≈æ√°dn√Ω kontext)';
      document.getElementById('context').textContent = ctxText;
    } else {
      document.getElementById('context').textContent = '‚ùå Kontext se nepoda≈ôilo naƒç√≠st';
    }
  } catch (e) {
    document.getElementById('context').textContent = '‚ùå Kontext se nepoda≈ôilo naƒç√≠st';
  }
  const formData = new FormData();
  formData.append('message', msg);
  formData.append('private', document.getElementById('mem-private').checked ? '1' : '0');
  if (file) formData.append('file', file);
  if (document.getElementById('save-txt').checked) formData.append('save', '1');

  let res;
  try {
    res = await authFetch('/ask_file', { method: 'POST', body: formData });
  } catch (e) {
    document.getElementById('response').textContent = '‚ùå Chyba p≈ôi odes√≠l√°n√≠';
    document.getElementById('spinner').style.display = 'none';
    return;
  }

  const contentType = res.headers.get('Content-Type') || '';

  if (!res.ok) {
    let errText = res.statusText || `HTTP ${res.status}`;
    if (contentType.includes('application/json')) {
      const data = await res.json();
      errText = data.error || errText;
    }
    document.getElementById('response').textContent = `‚ùå ${errText}`;
  } else if (contentType.includes('application/json')) {
    const data = await res.json();
    document.getElementById('response').textContent = data.response || '‚ùå Chyba odpovƒõdi';
    const link = document.getElementById('download');
    if (data.download_url) {
      link.href = data.download_url;
      link.textContent = '‚¨áÔ∏è St√°hnout odpovƒõƒè';
      link.style.display = 'inline';
    }
  } else {
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const answer = res.headers.get('X-Answer') || '';
    document.getElementById('response').textContent = answer || '‚ùå Chyba odpovƒõdi';
    const disposition = res.headers.get('Content-Disposition') || '';
    let filename = 'response';
    const m = disposition.match(/filename="?([^";]+)"?/);
    if (m) filename = m[1];
    const link = document.getElementById('download');
    link.href = url;
    link.download = filename;
    link.textContent = `‚¨áÔ∏è ${filename}`;
    link.style.display = 'inline';
  }

  document.getElementById('spinner').style.display = 'none';
  document.getElementById('message').value = '';
  fileInput.value = '';
}

document.getElementById('message').addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    ask();
  }
});
checkAuth();
</script>
</body>
</html>
